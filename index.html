<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapitulasi SKP Tahun 2024 ASN Guru Kab. Sampang di SIMPEG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .table-container { max-height: 60vh; overflow-y: auto; }
        .table-container::-webkit-scrollbar { width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        thead th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="container mx-auto p-4 sm:p-6 max-w-7xl">
        <!-- Notifikasi -->
        <div id="notification" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50">
            <p>Notifikasi</p>
        </div>

        <!-- Modal Kata Sandi -->
        <div id="passwordModal" class="hidden fixed inset-0 z-40 flex items-center justify-center modal-backdrop">
            <div class="modal bg-white rounded-lg shadow-xl w-full max-w-sm p-6" style="transform: scale(0.95); opacity: 0;">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Akses Terbatas</h3>
                <p class="text-gray-600 mb-4">Silakan masukkan kata sandi untuk mengakses menu admin.</p>
                <input type="password" id="passwordInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Kata Sandi">
                <p id="passwordError" class="text-red-500 text-sm mt-2 hidden">Kata sandi salah. Silakan coba lagi.</p>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancelPassword" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Batal</button>
                    <button id="submitPassword" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Masuk</button>
                </div>
            </div>
        </div>

        <!-- Header dan Navigasi -->
        <header class="bg-white p-4 rounded-lg shadow-md mb-6">
             <nav class="flex items-center justify-between">
                <div class="text-lg font-bold text-gray-700">
                    Menu Aplikasi
                </div>
                <div class="flex space-x-2">
                    <button id="mainViewBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md shadow-sm">Halaman Utama</button>
                    <button id="adminViewBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Menu Admin</button>
                </div>
            </nav>
        </header>

        <!-- Konten Utama -->
        <main class="bg-white p-4 sm:p-6 rounded-lg shadow-md min-h-[70vh]">
            <!-- Konten Halaman Utama -->
            <div id="mainView">
                <div class="text-center mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-700">Rekapitulasi SKP Tahun 2024 ASN Guru Kab. Sampang di SIMPEG</h1>
                    <p class="text-lg text-gray-600 mt-1">Kabupaten Sampang</p>
                    <p class="text-sm text-gray-500 mt-4">Rekapitulasi ini berdasarkan hasil respon formulir di <a href="https://s.id/lapor-skp" target="_blank" class="text-blue-600 hover:underline font-bold">https://s.id/lapor-skp</a>.</p>
                    <p class="text-sm text-gray-500 mt-1">Bagi Bapak/Ibu ASN guru jika SKP Tahun 2024 masih belum muncul di SIMPEG disilakan mengisi link di atas. Jika sudah mengisi link dan ternyata pada kolom status SKP sudah dinyatakan 'Sudah Muncul' namun saat dicek di aplikasi SIMPEG masih "belum muncul", silahkan konfirmasi kembali dengan cara mengisi kembali link form di atas.</p>
                    <p id="lastUpdateInfo" class="text-xs text-gray-400 mt-2">Data terakhir diperbarui: -</p>
                </div>

                <!-- Video Tutorial Section -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 text-center mb-4">Video Tutorial Penggunaan Aplikasi</h3>
                    <div class="aspect-video w-full max-w-3xl mx-auto rounded-lg overflow-hidden shadow-xl ring-1 ring-gray-900/10">
                        <iframe class="w-full h-full" src="https://www.youtube.com/embed/vxz9Fz-KWRM?si=KZPFlp8e8MOJzdEp" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                    </div>
                    <p class="text-center text-xs text-gray-500 mt-3">
                        Jika video tidak muncul, Anda bisa menontonnya langsung di 
                        <a href="https://www.youtube.com/watch?v=vxz9Fz-KWRM" target="_blank" class="text-blue-600 hover:underline">YouTube</a>.
                    </p>
                </div>

                <div class="mt-8 mb-4">
                    <p id="lastUpdateInfoTable" class="text-sm text-gray-500 mb-2 text-right">Data terakhir diperbarui: -</p>
                    <input type="text" id="searchInput" placeholder="Cari data di sini (NIP, Nama, Unit Kerja, dll)..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="table-container rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="dataTableHeader"></thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="text-center py-10"><div class="loader mx-auto"></div><p class="mt-2 text-gray-500">Memuat data...</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Konten Halaman Admin -->
            <div id="adminView" class="hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Menu Kelola Data SKP</h2>

                <!-- Section for Manual Update Time -->
                <div class="bg-yellow-50 border-2 border-dashed border-yellow-300 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 text-center">Perbarui Waktu Update Manual</h3>
                    <p class="text-sm text-gray-500 mb-4 text-center">Jika waktu update otomatis gagal, ketik manual di sini (contoh: Sabtu, 11 Oktober 2025 10:15 WIB).</p>
                    <div class="flex justify-center items-center gap-2">
                        <input type="text" id="manualUpdateInput" class="w-full max-w-sm px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Sabtu, 11 Oktober 2025 10:15 WIB">
                        <button id="saveManualUpdateBtn" class="px-5 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">Simpan Waktu</button>
                    </div>
                </div>
                
                <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 mb-6 text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Impor Data dari Excel/CSV</h3>
                    <p class="text-sm text-gray-500 mb-4">Pilih file untuk **MENGGANTI** seluruh data yang ada.</p>
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="block w-full max-w-xs mx-auto text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button id="processButton" class="mt-4 px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400" disabled>Proses & Ganti Data</button>
                </div>

                <div class="mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Edit Data Secara Manual</h3>
                        <button id="addRowBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">+ Tambah Data</button>
                    </div>
                    <div class="table-container rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead id="adminTableHeader"></thead>
                            <tbody id="adminTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="text-center py-10"><div class="loader mx-auto"></div><p class="mt-2 text-gray-500">Memuat data...</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>&copy; 2025 | Dikembangkan oleh Yoyon Sugiyono, S.Pd., M.Pd., Gr.</p>
            <p>UPTD SDN Margantoko 2, Kabupaten Sampang</p>
        </footer>
    </div>

    <script type="module">
        // Impor fungsi yang kita butuhkan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, writeBatch, serverTimestamp, getDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Konfigurasi Firebase Anda
        const firebaseConfig = {
          apiKey: "AIzaSyBeLLP1N7heUvLUJuD6oXcQEpmI-mMaPes",
          authDomain: "rekap-skp-sampang.firebaseapp.com",
          projectId: "rekap-skp-sampang",
          storageBucket: "rekap-skp-sampang.firebasestorage.app",
          messagingSenderId: "10311895351",
          appId: "1:10311895351:web:8dbaa535d011c4931c32b2"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Kode aplikasi utama
        const dataCollection = collection(db, 'skp-data');
        const metadataDocRef = doc(db, 'metadata', 'app-status');

        const mainView = document.getElementById('mainView');
        const adminView = document.getElementById('adminView');
        const mainViewBtn = document.getElementById('mainViewBtn');
        const adminViewBtn = document.getElementById('adminViewBtn');
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const passwordError = document.getElementById('passwordError');
        const submitPassword = document.getElementById('submitPassword');
        const cancelPassword = document.getElementById('cancelPassword');
        const notification = document.getElementById('notification');
        const addRowBtn = document.getElementById('addRowBtn');
        const searchInput = document.getElementById('searchInput');
        const dataTableBody = document.getElementById('dataTableBody');
        const adminTableBody = document.getElementById('adminTableBody');
        const lastUpdateInfo = document.getElementById('lastUpdateInfo');
        const lastUpdateInfoTable = document.getElementById('lastUpdateInfoTable');
        const manualUpdateInput = document.getElementById('manualUpdateInput');
        const saveManualUpdateBtn = document.getElementById('saveManualUpdateBtn');

        let currentData = [];
        let headers = ['No.', 'NIP/NIPPPK', 'Nama ASN', 'Unit Kerja', 'Status SKP di SIMPEG', 'Keterangan'];
        const ADMIN_PASSWORD = 'firdy@2930';

        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.classList.remove('hidden');
            notification.classList.toggle('bg-red-500', isError);
            notification.classList.toggle('bg-green-500', !isError);
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 4000); // Durasi notifikasi lebih lama agar mudah dibaca
        }

        function switchView(view) {
            if (view === 'admin') {
                mainView.classList.add('hidden');
                adminView.classList.remove('hidden');
                adminViewBtn.classList.replace('bg-gray-200', 'bg-blue-600');
                adminViewBtn.classList.replace('text-gray-700', 'text-white');
                mainViewBtn.classList.replace('bg-blue-600', 'bg-gray-200');
                mainViewBtn.classList.replace('text-white', 'text-gray-700');
            } else {
                adminView.classList.add('hidden');
                mainView.classList.remove('hidden');
                mainViewBtn.classList.replace('bg-gray-200', 'bg-blue-600');
                mainViewBtn.classList.replace('text-gray-700', 'text-white');
                adminViewBtn.classList.replace('bg-blue-600', 'bg-gray-200');
                adminViewBtn.classList.replace('text-white', 'text-gray-700');
            }
        }

        function renderHeaders() {
            const headerRow = (h) => `<tr><th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">No.</th>${h.map(header => `<th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">${header}</th>`).join('')}</tr>`;
            const adminHeaderRow = (h) => `<tr><th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">No.</th>${h.map(header => `<th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">${header}</th>`).join('')}<th scope="col" class="relative px-4 py-3"><span class="sr-only">Aksi</span></th></tr>`;
            
            const displayHeaders = headers.slice(1);
            document.getElementById('dataTableHeader').innerHTML = headerRow(displayHeaders);
            document.getElementById('adminTableHeader').innerHTML = adminHeaderRow(displayHeaders);
        }

        function filterAndRender(searchTerm = '') {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredData = currentData.filter(row => 
                Object.values(row.data).some(value => 
                    String(value).toLowerCase().includes(lowerCaseSearchTerm)
                )
            );
            renderData(filteredData);
        }

        function renderData(data) {
            if (!dataTableBody) return;
            if (data.length === 0) {
                dataTableBody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-10 text-gray-500">Tidak ada data untuk ditampilkan.</td></tr>`;
                return;
            }
            const displayHeaders = headers.slice(1);
            const tableRows = data.map((row, index) => {
                const status = (row.data['Status SKP di SIMPEG'] || '').trim().toLowerCase();
                const rowClass = status.includes('tidak') || status.includes('belum') ? 'bg-red-100 text-red-800 font-medium' : 'text-gray-600 hover:bg-gray-50';
                return `<tr class="${rowClass}">
                    <td class="px-4 py-3 text-sm whitespace-nowrap text-center">${index + 1}</td>
                    ${displayHeaders.map(header => `<td class="px-4 py-3 text-sm whitespace-nowrap">${row.data[header] || ''}</td>`).join('')}
                </tr>`;
            }).join('');
            dataTableBody.innerHTML = tableRows;
        }
        
        function renderAdminTable(data) {
            if (!adminTableBody) return;
            if (data.length === 0) {
                adminTableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="text-center py-10 text-gray-500">Tidak ada data. Tambahkan atau impor.</td></tr>`;
                return;
            }
            const displayHeaders = headers.slice(1);
            const tableRows = data.map((row, index) => {
                const status = (row.data['Status SKP di SIMPEG'] || '').trim().toLowerCase();
                const rowClass = status.includes('tidak') || status.includes('belum') ? 'bg-red-100 text-red-800 font-medium' : 'text-gray-600 hover:bg-gray-50';
                return `<tr class="${rowClass}" data-id="${row.id}">
                    <td class="px-4 py-3 text-sm whitespace-nowrap text-center">${index + 1}</td>
                    ${displayHeaders.map(header => `<td class="px-4 py-3 text-sm whitespace-nowrap"><input type="text" name="${header}" value="${row.data[header] || ''}" class="w-full bg-transparent border-none p-1 rounded focus:ring-2 focus:ring-blue-500" readonly></td>`).join('')}
                    <td class="px-4 py-3 text-sm whitespace-nowrap text-right">
                        <button class="edit-btn text-blue-600 hover:text-blue-800">Edit</button>
                        <button class="delete-btn text-red-600 hover:text-red-800 ml-2">Hapus</button>
                    </td>
                </tr>`;
            }).join('');
            adminTableBody.innerHTML = tableRows;
        }
        
        function renderAllTables() {
            filterAndRender(searchInput.value);
            renderAdminTable(currentData);
        }

        async function updateLastUpdatedTimestamp() {
            try {
                // Set the server timestamp and remove the manual override
                await setDoc(metadataDocRef, { 
                    lastUpdated: serverTimestamp(),
                    manualUpdateString: deleteField()
                }, { merge: true });
                console.log("Last updated timestamp successfully updated.");
            } catch (error) {
                console.error("Error updating last updated timestamp: ", error);
                 if (error.code === 'permission-denied') {
                    showNotification('Gagal update waktu: Hak akses ditolak. Periksa Aturan Keamanan Firestore Anda.', true);
                } else {
                    showNotification('Gagal memperbarui waktu otomatis.', true);
                }
            }
        }

        async function initializeAppAndListeners() {
            try {
                await signInAnonymously(auth);
                console.log('User signed in anonymously');

                onSnapshot(dataCollection, (snapshot) => {
                    currentData = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                    currentData.sort((a, b) => (a.data['Nama ASN'] || '').localeCompare(b.data['Nama ASN'] || ''));
                    
                    if (currentData.length > 0 && !headers.includes('Nama ASN')) { 
                       const firstItemHeaders = Object.keys(currentData[0].data);
                       const desiredOrder = ['NIP/NIPPPK', 'Nama ASN', 'Unit Kerja', 'Status SKP di SIMPEG', 'Keterangan'];
                       const sortedHeaders = desiredOrder.filter(h => firstItemHeaders.includes(h));
                       const otherHeaders = firstItemHeaders.filter(h => !desiredOrder.includes(h));
                       headers = ['No.', ...sortedHeaders, ...otherHeaders];
                       renderHeaders();
                    } else if (headers.length <= 2) { 
                        renderHeaders();
                    }
                    
                    renderAllTables();
                });

                onSnapshot(metadataDocRef, (docSnap) => {
                    let updateText;
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Prioritize manual update string if it exists
                        if (data.manualUpdateString) {
                            updateText = `Data terakhir diperbarui: ${data.manualUpdateString}`;
                        } 
                        // Fallback to automatic timestamp
                        else if (data.lastUpdated) {
                            const timestamp = data.lastUpdated.toDate();
                            const formattedDate = timestamp.toLocaleString('id-ID', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            updateText = `Data terakhir diperbarui: ${formattedDate} WIB`;
                        } else {
                             updateText = 'Data terakhir diperbarui: Belum ada informasi';
                        }
                    } else {
                        updateText = 'Data terakhir diperbarui: Belum ada informasi';
                    }
                    lastUpdateInfo.textContent = updateText;
                    lastUpdateInfoTable.textContent = updateText;
                });

            } catch (error) {
                console.error("Authentication or Firestore listener error:", error);
                let errorMessage = '<p class="text-red-500">Gagal memuat data. Periksa konsol untuk detail.</p>';
                if (error.code === 'auth/configuration-not-found') {
                    showNotification("Error: Anonymous Sign-In belum diaktifkan di Firebase.", true);
                    errorMessage = '<p class="text-red-500 text-center px-4">Gagal memuat data. <br><b>Aksi yang diperlukan:</b> Aktifkan "Anonymous" sebagai metode Sign-in di Firebase Authentication Console Anda.</p>';
                } else {
                    showNotification("Gagal memuat data: Masalah perizinan. Coba segarkan halaman.", true);
                }

                const loadingIndicator = document.querySelector('#dataTableBody tr td');
                if(loadingIndicator) {
                    loadingIndicator.innerHTML = errorMessage;
                }
                const adminLoadingIndicator = document.querySelector('#adminTableBody tr td');
                if(adminLoadingIndicator) {
                    adminLoadingIndicator.innerHTML = errorMessage;
                }
            }
        }

        // Initialize App
        initializeAppAndListeners();


        // UI Event Listeners
        mainViewBtn.addEventListener('click', () => switchView('main'));
        adminViewBtn.addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
            setTimeout(() => {
                passwordModal.querySelector('.modal').style.transform = 'scale(1)';
                passwordModal.querySelector('.modal').style.opacity = '1';
                passwordInput.focus();
            }, 10);
        });
        cancelPassword.addEventListener('click', () => {
            passwordModal.querySelector('.modal').style.transform = 'scale(0.95)';
            passwordModal.querySelector('.modal').style.opacity = '0';
            setTimeout(() => { passwordModal.classList.add('hidden'); passwordInput.value = ''; passwordError.classList.add('hidden'); }, 300);
        });
        submitPassword.addEventListener('click', () => {
            if (passwordInput.value === ADMIN_PASSWORD) { cancelPassword.click(); switchView('admin'); } else { passwordError.classList.remove('hidden'); passwordInput.select(); }
        });
        passwordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') submitPassword.click(); });
        fileInput.addEventListener('change', () => { processButton.disabled = !fileInput.files.length; });
        
        processButton.addEventListener('click', async () => {
            if (!confirm('Anda yakin ingin MENGGANTI SEMUA data yang ada dengan data dari file ini? Aksi ini tidak bisa dibatalkan.')) {
                return;
            }
            
            const file = fileInput.files[0];
            if (!file) return;

            processButton.disabled = true;
            processButton.textContent = 'Memproses...';

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });

                    if (jsonData.length > 0) {
                        const batchDelete = writeBatch(db);
                        currentData.forEach(docItem => {
                            batchDelete.delete(doc(dataCollection, docItem.id));
                        });
                        await batchDelete.commit();

                        const batchAdd = writeBatch(db);
                        jsonData.forEach(row => {
                            const newDocRef = doc(dataCollection);
                            batchAdd.set(newDocRef, row);
                        });
                        await batchAdd.commit();
                        
                        await updateLastUpdatedTimestamp();
                        showNotification('Semua data berhasil diganti dengan data dari file!');
                        switchView('main');
                    } else {
                        showNotification('File kosong atau format tidak sesuai.', true);
                    }
                };
                reader.onerror = () => showNotification('Gagal membaca file.', true);
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("Error processing file: ", error);
                showNotification('Terjadi kesalahan saat memproses file.', true);
            } finally {
                processButton.disabled = false;
                processButton.textContent = 'Proses & Ganti Data';
                fileInput.value = '';
            }
        });
        
        searchInput.addEventListener('input', (e) => filterAndRender(e.target.value));

        addRowBtn.addEventListener('click', () => {
             const newRow = document.createElement('tr');
             newRow.classList.add('bg-green-50');
             const displayHeaders = headers.slice(1);
             newRow.innerHTML = `
                <td class="px-4 py-3 text-sm whitespace-nowrap text-center font-bold">*</td>
                ${displayHeaders.map(header => `<td class="px-4 py-3 text-sm whitespace-nowrap"><input type="text" name="${header}" value="" placeholder="${header}" class="w-full bg-white border border-gray-300 p-1 rounded focus:ring-2 focus:ring-blue-500"></td>`).join('')}
                <td class="px-4 py-3 text-sm whitespace-nowrap text-right">
                    <button class="save-btn text-green-600 hover:text-green-800">Simpan</button>
                    <button class="cancel-btn text-gray-600 hover:text-gray-800 ml-2">Batal</button>
                </td>`;
             adminTableBody.prepend(newRow);
             newRow.querySelector('input').focus();
        });

        adminTableBody.addEventListener('click', async (e) => {
            const row = e.target.closest('tr');
            if (!row) return;
            const docId = row.dataset.id;

            if (e.target.classList.contains('edit-btn')) {
                row.querySelectorAll('input').forEach(input => input.readOnly = false);
                e.target.textContent = 'Simpan';
                e.target.classList.remove('edit-btn'); e.target.classList.add('save-edit-btn', 'text-green-600');
                row.querySelector('input').focus();
            } 
            else if (e.target.classList.contains('save-edit-btn')) {
                const updatedRowData = {};
                row.querySelectorAll('input[name]').forEach(input => { updatedRowData[input.name] = input.value; });
                try {
                    await setDoc(doc(db, 'skp-data', docId), updatedRowData);
                    await updateLastUpdatedTimestamp();
                    showNotification('Data berhasil diperbarui.');
                } catch (error) { showNotification('Gagal memperbarui data.', true); }
            }
            else if (e.target.classList.contains('delete-btn')) {
                if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                    try {
                        await deleteDoc(doc(db, 'skp-data', docId));
                        await updateLastUpdatedTimestamp();
                        showNotification('Data berhasil dihapus.');
                    } catch (error) { showNotification('Gagal menghapus data.', true); }
                }
            }
            else if (e.target.classList.contains('save-btn')) {
                const newRowData = {};
                row.querySelectorAll('input[name]').forEach(input => { newRowData[input.name] = input.value; });
                try {
                    await addDoc(dataCollection, newRowData);
                    await updateLastUpdatedTimestamp();
                    showNotification('Data baru berhasil ditambahkan.');
                } catch (error) { showNotification('Gagal menambah data.', true); }
            }
            else if (e.target.classList.contains('cancel-btn')) { row.remove(); }
        });

        saveManualUpdateBtn.addEventListener('click', async () => {
            const manualTimeString = manualUpdateInput.value.trim();
            if (!manualTimeString) {
                showNotification('Harap masukkan teks waktu pembaruan.', true);
                return;
            }
            try {
                await setDoc(metadataDocRef, { manualUpdateString: manualTimeString }, { merge: true });
                showNotification('Waktu pembaruan manual berhasil disimpan.');
                manualUpdateInput.value = '';
            } catch (error) {
                console.error("Error saving manual update time: ", error);
                if (error.code === 'permission-denied') {
                    showNotification('Gagal: Hak akses ditolak. Periksa Aturan Keamanan Firestore Anda.', true);
                } else {
                    showNotification('Gagal menyimpan waktu pembaruan.', true);
                }
            }
        });
    </script>
</body>
</html>

